input {
    # https://www.elastic.co/guide/en/logstash/current/plugins-inputs-file.html
    file {
        path => '/logs/**/*.log'
        file_completed_action => 'delete'
        exit_after_read => true
        mode => 'read'
    }
}
filter {

    if ([message] =~ /^#/) {
        drop{}
    }

    # https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html
    grok {
        match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{WORD:S-SiteName} %{NOTSPACE:S-ComputerName} %{IPORHOST:S-IP} %{WORD:CS-Method} %{URIPATH:CS-URI-Stem} %{NOTSPACE:CS-URI-Query} %{NUMBER:S-Port} %{NOTSPACE:CS-Username} %{IPORHOST:C-IP} %{NOTSPACE:CS-Version} %{NOTSPACE:CS-UserAgent} %{NOTSPACE:CS-Cookie} %{NOTSPACE:CS-Referer} %{NOTSPACE:CS-Host} %{NUMBER:SC-Status} %{NUMBER:SC-SubStatus} %{NUMBER:SC-Win32-Status} %{NUMBER:SC-Bytes} %{NUMBER:CS-Bytes} %{NUMBER:Time-Taken} %{NOTSPACE:CS-IP-Forwarded} %{NOTSPACE:CS-IP-Forwarded-For} %{NOTSPACE:CN}%{GREEDYDATA:extras}" } }

        #Multiple patterns
        # match => 
        # [
        # "%{TIMESTAMP_ISO8601:timestamp} %{WORD:S-SiteName} %{NOTSPACE:S-ComputerName} %{IPORHOST:S-IP} %{WORD:CS-Method} %{URIPATH:CS-URI-Stem} %{NOTSPACE:CS-URI-Query} %{NUMBER:S-Port} %{NOTSPACE:CS-Username} %{IPORHOST:C-IP} %{NOTSPACE:CS-Version} %{NOTSPACE:CS-UserAgent} %{NOTSPACE:CS-Cookie} %{NOTSPACE:CS-Referer} %{NOTSPACE:CS-Host} %{NUMBER:SC-Status} %{NUMBER:SC-SubStatus} %{NUMBER:SC-Win32-Status} %{NUMBER:SC-Bytes} %{NUMBER:CS-Bytes} %{NUMBER:Time-Taken} %{NOTSPACE:CS-IP-Forwarded} %{NOTSPACE:CS-IP-Forwarded-For} %{WORD:CN}",
        #
        # "%{TIMESTAMP_ISO8601:timestamp} %{WORD:S-SiteName} %{NOTSPACE:S-ComputerName} %{IPORHOST:S-IP} %{WORD:CS-Method} %{URIPATH:CS-URI-Stem} %{NOTSPACE:CS-URI-Query} %{NUMBER:S-Port} %{NOTSPACE:CS-Username} %{IPORHOST:C-IP} %{NOTSPACE:CS-Version} %{NOTSPACE:CS-UserAgent} %{NOTSPACE:CS-Cookie} %{NOTSPACE:CS-Referer} %{NOTSPACE:CS-Host} %{NUMBER:SC-Status} %{NUMBER:SC-SubStatus} %{NUMBER:SC-Win32-Status} %{NUMBER:SC-Bytes} %{NUMBER:CS-Bytes} %{NUMBER:Time-Taken} %{NOTSPACE:CS-IP-Forwarded} %{NOTSPACE:CS-IP-Forwarded-For} %{WORD:CN} %{GREEDYDATA:extras}"
        # ]
        # }

    date {
        match => [ "timestamp", "YYYY-MM-dd HH:mm:ss", "ISO8601" ]
        target => "@timestamp"
		    timezone => "Etc/UTC"
    }    
    mutate {
		    remove_field => [ "event"]
    }
}
output {
  elasticsearch {
      hosts => localhost
      manage_template => false
      index => "iis-logs"
  }
}
